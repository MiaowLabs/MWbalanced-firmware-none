C51 COMPILER V9.00   UPSTANDINGCAR                                                         11/22/2015 19:59:43 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE UPSTANDINGCAR
OBJECT MODULE PLACED IN .\output\upstandingcar.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE user\upstandingcar.c LARGE BROWSE INCDIR(.\common;.\driver;.\user) DEBUG OB
                    -JECTEXTEND PRINT(.\listing\upstandingcar.lst) OBJECT(.\output\upstandingcar.obj)

line level    source

   1          
   2          
   3          #include "includes.h"
   4          
   5          
   6          unsigned int flag_ok;
   7          unsigned char xdata g_ucLEDCount;
   8          int g_iCarSpeedSet;
   9          /******电机控制参数******/
  10          float g_fSpeedControlOut;
  11          float g_fAngleControlOut;
  12          float g_fLeftMotorOut;
  13          float g_fRightMotorOut;
  14          /******角度控制参数******/
  15          int   g_iAccelInputVoltage_Y_Axis ;     //加速度Y轴数据
  16          int   g_iGyroInputVoltage_X_Axis  ;     //陀螺仪X轴数据
  17          long int  g_liAccAdd;
  18          long int  g_liGyroAdd;
  19          float g_fCarAngle;                              //车模倾角
  20          float g_fGyroAngleSpeed;                        //角速度                        
  21          float g_fGyroscopeAngleIntegral;        //角速度积分值
  22          float g_fGravityAngle;                          //加速度初步计算得到的倾角
  23          int g_iGyroOffset;
  24          /******速度控制参数******/
  25          int   g_iLeftMotorPulse;
  26          int   g_iRightMotorPulse;
  27          int   g_iLeftMotorPulseSigma;
  28          int   g_iRightMotorPulseSigma;
  29          float g_fCarSpeed;
  30          float g_fCarSpeedOld;
  31          float g_fCarPosition;
  32          //unsigned char g_ucSpeedCountCarry;
  33          float g_fSpeedControlOutNew        ;
  34          float g_fSpeedControlOutOld;
  35          unsigned char g_ucSpeedControlPeriod ;
  36          unsigned char g_ucSpeedControlCount ;
  37          
  38          /*-----角度环和速度环PID控制参数-----*/
  39          float code g_fcAngle_P = 1300.0;//1300
  40          float code g_fcAngle_D = 19.0;  
  41          float code g_fcSpeed_P = 200.0 ; //200
  42          float code g_fcSpeed_I = 5.5;              
  43          /******蓝牙控制参数******/
  44          float xdata g_fBluetoothSpeed;
  45          float xdata g_fBluetoothDirection;
  46          unsigned char  xdata g_uc2msEventCount;
  47          
  48          /***************************************************************
  49          ** 函数名称: CarUpstandInit
  50          ** 功能描述: 全局变量初始化函数
  51          ** 输　入:   
  52          ** 输　出:   
  53          ** 全局变量: 
  54          ** 作　者:   喵呜实验室
C51 COMPILER V9.00   UPSTANDINGCAR                                                         11/22/2015 19:59:43 PAGE 2   

  55          ** 淘  宝：  Http://miaowlabs.taobao.com
  56          ** 日　期:   2014年08月01日
  57          ***************************************************************/
  58          void CarUpstandInit()
  59          {
  60   1              g_iAccelInputVoltage_Y_Axis = g_iGyroInputVoltage_X_Axis = 0;
  61   1              g_iLeftMotorPulse = g_iRightMotorPulse = 0;
  62   1      
  63   1              g_fCarSpeed    = 0;
  64   1              g_fCarPosition = 0;
  65   1              g_fCarAngle    = 0;
  66   1              g_fGyroAngleSpeed = 0;
  67   1              g_fGravityAngle   = 0;
  68   1              g_fGyroscopeAngleIntegral = 0;
  69   1      
  70   1              g_fAngleControlOut = g_fSpeedControlOut = 0;
  71   1      
  72   1              g_fLeftMotorOut    = g_fRightMotorOut   = 0;
  73   1              g_fBluetoothSpeed  = g_fBluetoothDirection = 0;
  74   1      
  75   1          g_ucLEDCount = 0;
  76   1              g_ucSpeedCountCarry = 0;
  77   1      
  78   1              g_fSpeedControlOutNew = g_fSpeedControlOutOld = 0;
  79   1      
  80   1              g_iCarSpeedSet=0;
  81   1      
  82   1              flag_ok=0;
  83   1      
  84   1      }
  85          /***************************************************************
  86          ** 函数名称: DataSynthesis
  87          ** 功能描述: MPU6050数据合成函数
  88          ** 输　入:   REG_Address : 地址
  89          ** 输　出:   合成数据
  90          ** 全局变量: 
  91          ** 作　者:   喵呜实验室
  92          ** 淘  宝：  Http://miaowlabs.taobao.com
  93          ** 日　期:   2014年08月01日
  94          ***************************************************************/
  95          int DataSynthesis(unsigned char REG_Address)    
  96          {
  97   1              char idata uiHighByte; /*高八位*/
  98   1              char idata ucLowByte; /*低八位*/
  99   1      
 100   1              uiHighByte = Single_ReadI2C(REG_Address)  ;
 101   1              ucLowByte  = Single_ReadI2C(REG_Address+1);
 102   1      
 103   1              return ((uiHighByte << 8) + ucLowByte);   /*返回合成数据*/
 104   1      }
 105          /***************************************************************
 106          ** 函数名称: SampleInputVoltage
 107          ** 功能描述: 采样函数             
 108          ** 输　入:   
 109          ** 输　出:   
 110          ** 全局变量: 
 111          ** 作　者:   喵呜实验室
 112          ** 淘  宝：  Http://miaowlabs.taobao.com
 113          ** 日　期:   2014年08月01日
 114          ***************************************************************/
 115          void SampleInputVoltage(void)
 116          {       
C51 COMPILER V9.00   UPSTANDINGCAR                                                         11/22/2015 19:59:43 PAGE 3   

 117   1      #if 0 
                  /*
                      N次均值滤波，此处N取20。
                      会降低频响，N值要适当，不宜过大过小。
                      */      
                      unsigned char ucValue;   
                      for(ucValue = 0 ; ucValue < 20 ; ucValue ++)
                      {
                              g_iAccelInputVoltage_Y_Axis  = DataSynthesis(ACCEL_YOUT_H);//加速度Y轴
                              g_iGyroInputVoltage_X_Axis = DataSynthesis(GYRO_XOUT_H);//陀螺仪X轴
                      
                              g_liAccAdd += g_iAccelInputVoltage_Y_Axis;
                              g_liGyroAdd += g_iGyroInputVoltage_X_Axis;                      
                                                              
                      }       
              
                      g_iAccelInputVoltage_Y_Axis = g_liAccAdd  / 20 ;
                  g_iGyroInputVoltage_X_Axis  = g_liGyroAdd / 20 ;
              
                      g_liAccAdd  = 0;          /*滤波完全局变量要清零，下次调用才不会出错*/
                  g_liGyroAdd = 0;
              
              #else   /*不作任何滤波处理*/
 140   1                      g_iGyroInputVoltage_X_Axis   = DataSynthesis(GYRO_XOUT_H) ; //陀螺仪X轴
 141   1              g_iAccelInputVoltage_Y_Axis  = DataSynthesis(ACCEL_YOUT_H); //加速度Y轴
 142   1                      
 143   1      
 144   1      #endif  
 145   1      }
 146          void GetGyroOffset()
 147          {
 148   1              long int aa;
 149   1              //int bb;
 150   1              int tt;
 151   1              for(tt=0;tt<1000;tt++)
 152   1              {
 153   2                      aa+=DataSynthesis(GYRO_XOUT_H) ;
 154   2              }
 155   1              g_iGyroOffset = aa/1000;
 156   1              aa=0;
 157   1      }
 158          /***************************************************************
 159          ** 函数名称: SetMotorVoltageAndDirection
 160          ** 功能描述: 电机转速及方向控制函数             
 161          ** 输　入:   
 162          ** 输　出:   
 163          ** 全局变量: 
 164          ** 作　者:   喵呜实验室
 165          ** 淘  宝：  Http://miaowlabs.taobao.com
 166          ** 日　期:   2014年08月01日
 167          ***************************************************************/
 168          void SetMotorVoltageAndDirection(float fLeftVoltage,float fRightVoltage)
 169          {
 170   1              int  iLeftMotorValue;
 171   1              int  iRighttMotorValue;
 172   1              
 173   1              iLeftMotorValue = (int) fLeftVoltage;
 174   1              iRighttMotorValue = (int) fRightVoltage;
 175   1      
 176   1              
 177   1      
 178   1          if(iLeftMotorValue<0)
C51 COMPILER V9.00   UPSTANDINGCAR                                                         11/22/2015 19:59:43 PAGE 4   

 179   1          {        
 180   2                      iLeftMotorValue *= (-1);
 181   2      
 182   2                      iLeftMotorValue = 20000 - iLeftMotorValue ;
 183   2      
 184   2                      PWM2T1=20000;
 185   2                      PWM3T1=iLeftMotorValue;  
 186   2          }
 187   1          else 
 188   1          {   
 189   2                      iLeftMotorValue = 20000 - iLeftMotorValue ;
 190   2      
 191   2                      PWM2T1=iLeftMotorValue;
 192   2                      PWM3T1=20000;
 193   2          }
 194   1      
 195   1          if(iRighttMotorValue<0)
 196   1          {   
 197   2                      iRighttMotorValue *= (-1);
 198   2      
 199   2                      iRighttMotorValue = 20000 - iRighttMotorValue;
 200   2      
 201   2                      PWM5T1=20000;
 202   2                      PWM4T1=iRighttMotorValue;
 203   2          }
 204   1          else
 205   1          {   
 206   2                      iRighttMotorValue = 20000 - iRighttMotorValue;
 207   2      
 208   2                      PWM5T1=iRighttMotorValue;
 209   2                      PWM4T1=20000;
 210   2          }
 211   1      
 212   1         
 213   1      #if IF_CAR_FALL          /*判断车辆是否跌倒，调试用*/
 214   1      
 215   1              if(g_fCarAngle > 30 || g_fCarAngle < (-30))
 216   1              {
 217   2                      PWM2T1=20000;
 218   2                      PWM3T1=20000;
 219   2                      PWM4T1=20000;
 220   2                      PWM5T1=20000;
 221   2                      PWM2T2=1;
 222   2                      PWM3T2=1;
 223   2                      PWM5T2=1;
 224   2                      PWM4T2=1;
 225   2              }
 226   1      
 227   1      #endif
 228   1      }
 229          
 230          /***************************************************************
 231          ** 函数名称: MotorOutput
 232          ** 功能描述: 电机输出函数
 233                       将直立控制、速度控制、方向控制的输出量进行叠加,并加
 234                                   入死区常量，对输出饱和作出处理。
 235          ** 输　入:   
 236          ** 输　出:   
 237          ** 全局变量: 
 238          ** 作　者:   喵呜实验室
 239          ** 淘  宝：  Http://miaowlabs.taobao.com
 240          ** 日　期:   2014年08月01日
C51 COMPILER V9.00   UPSTANDINGCAR                                                         11/22/2015 19:59:43 PAGE 5   

 241          ***************************************************************/
 242          void MotorOutput(void)
 243          {
 244   1      
 245   1              g_fLeftMotorOut = g_fAngleControlOut - g_fSpeedControlOut + g_fBluetoothDirection ;
 246   1              g_fRightMotorOut = g_fAngleControlOut - g_fSpeedControlOut - g_fBluetoothDirection ;
 247   1                              
 248   1              
 249   1              /*增加死区常数*/
 250   1              if(g_fLeftMotorOut>0)       g_fLeftMotorOut  += MOTOR_OUT_DEAD_VAL;
 251   1              else if(g_fLeftMotorOut<0)  g_fLeftMotorOut  -= MOTOR_OUT_DEAD_VAL;
 252   1              if(g_fRightMotorOut>0)      g_fRightMotorOut += MOTOR_OUT_DEAD_VAL;
 253   1              else if(g_fRightMotorOut<0) g_fRightMotorOut -= MOTOR_OUT_DEAD_VAL;
 254   1      
 255   1              /*输出饱和处理，防止超出PWM范围*/       
 256   1              if(g_fLeftMotorOut  > MOTOR_OUT_MAX)    g_fLeftMotorOut  = MOTOR_OUT_MAX;
 257   1              if(g_fLeftMotorOut  < MOTOR_OUT_MIN)    g_fLeftMotorOut  = MOTOR_OUT_MIN;
 258   1              if(g_fRightMotorOut > MOTOR_OUT_MAX)    g_fRightMotorOut = MOTOR_OUT_MAX;
 259   1              if(g_fRightMotorOut < MOTOR_OUT_MIN)    g_fRightMotorOut = MOTOR_OUT_MIN;
 260   1      
 261   1          SetMotorVoltageAndDirection(g_fLeftMotorOut,g_fRightMotorOut);
 262   1      }
 263          
 264          void GetMotorPulse(void)
 265          {
 266   1              g_iRightMotorPulse = (T4H<<8) + T4L;
 267   1              g_iLeftMotorPulse  = (T3H<<8) + T3L;
 268   1              T4T3M&= 0x77;
 269   1              T4H=T4L=0;
 270   1              T3H=T3L=0;
 271   1              T4T3M |= 0xCC;
 272   1      
 273   1              if(!MOTOR_LEFT_SPEED_POSITIVE)  g_iLeftMotorPulse  = -g_iLeftMotorPulse ; 
 274   1              if(!MOTOR_RIGHT_SPEED_POSITIVE) g_iRightMotorPulse = -g_iRightMotorPulse;
 275   1      
 276   1              g_iLeftMotorPulseSigma += g_iLeftMotorPulse;
 277   1              g_iRightMotorPulseSigma += g_iRightMotorPulse;
 278   1      }
 279          /***************************************************************
 280          ** 函数名称: SpeedControl
 281          ** 功能描述: 速度环控制函数
 282          ** 输　入:   
 283          ** 输　出:   
 284          ** 全局变量: 
 285          ** 作　者:   喵呜实验室
 286          ** 淘  宝：  Http://miaowlabs.taobao.com
 287          ** 日　期:   2014年08月01日
 288          ***************************************************************/
 289          void SpeedControl(void)
 290          {  
 291   1              
 292   1              g_fCarSpeed = (g_iLeftMotorPulseSigma  + g_iRightMotorPulseSigma ) * 0.5;
 293   1          g_iLeftMotorPulseSigma = g_iRightMotorPulseSigma = 0;         //全局变量 注意及时清零
 294   1      
 295   1              /*低通滤波*/
 296   1          g_fCarSpeed = g_fCarSpeedOld * 0.2 + g_fCarSpeed * 0.8 ;
 297   1              g_fCarSpeedOld = g_fCarSpeed;                                                                                                                    
 298   1      
 299   1              //g_fCarSpeed *= CAR_SPEED_CONSTANT;     //单位：转/秒
 300   1              g_fCarPosition += g_fCarSpeed;           //路程  即速度积分
 301   1              g_fCarPosition += g_fBluetoothSpeed;
 302   1      
C51 COMPILER V9.00   UPSTANDINGCAR                                                         11/22/2015 19:59:43 PAGE 6   

 303   1                      /*积分上限设限*/                          
 304   1              if((int)g_fCarPosition > 20000)    g_fCarPosition = 20000;
 305   1              if((int)g_fCarPosition < (-20000))    g_fCarPosition = (-20000);
 306   1                                                              
 307   1              g_fSpeedControlOut = (CAR_SPEED_SET - g_fCarSpeed) * g_fcSpeed_P + \
 308   1              (CAR_POSITION_SET - g_fCarPosition) * g_fcSpeed_I; 
 309   1      
 310   1      }
 311          
 312          /***************************************************************
 313          ** 函数名称: AngleControl
 314          ** 功能描述: 角度环控制函数
 315          ** 输　入:   
 316          ** 输　出:   
 317          ** 全局变量: 
 318          ** 作　者:   喵呜实验室
 319          ** 淘  宝：  Http://miaowlabs.taobao.com
 320          ** 日　期:   2014年08月01日
 321          ***************************************************************/
 322          void AngleControl(void)  
 323          {  
 324   1              g_fGravityAngle = (float)(g_iAccelInputVoltage_Y_Axis - GRAVITY_OFFSET) / 16384.0f;   //去除零点偏移,计算
             -得到角度（弧度）
 325   1              g_fGravityAngle = g_fGravityAngle * 57.2957795f ;// 180/3.1415926535898//弧度转换为度,
 326   1              g_fGyroAngleSpeed = (g_iGyroInputVoltage_X_Axis  - GYRO_OFFSET) /10.0;// / 16.4;
 327   1      
 328   1              g_fCarAngle = 0.991*(g_fCarAngle + g_fGyroAngleSpeed * 0.008f) + 0.009*g_fGravityAngle;
 329   1              g_fAngleControlOut = (CAR_ANGLE_SET - g_fCarAngle)* g_fcAngle_P + \
 330   1              (CAR_ANGULARSPEED_SET - g_fGyroAngleSpeed )* g_fcAngle_D ;         
 331   1               
 332   1      }
 333          
 334          /***************************************************************
 335          ** 函数名称: BluetoothControl
 336          ** 功能描述: 蓝牙控制函数
 337                       手机发送内容
 338                                   上：00000010    下：00000001
 339                       左：00000011    右：00000100
 340                       停止：00000000
 341                       功能键（可自编下位机程序扩展）：
 342                       A:00000101      B:00000110
 343                       C:00000111      D:00001000
 344          ** 输　入:   
 345          ** 输　出:   
 346          ** 全局变量: 
 347          ** 作　者:   喵呜实验室
 348          ** 淘  宝：  Http://miaowlabs.taobao.com
 349          ** 日　期:   2014年08月01日
 350          ***************************************************************/
 351          void BluetoothControl(void)      
 352          {
 353   1              unsigned char xdata ucBluetoothValue;
 354   1      
 355   1              LED0=~LED0;
 356   1      
 357   1              ucBluetoothValue = UART2ReceiveByte();          
 358   1              switch (ucBluetoothValue)
 359   1              {
 360   2                case 0x02 : g_fBluetoothSpeed =   100 ;  break;          //前进
 361   2                case 0x01 : g_fBluetoothSpeed = (-100);  break;          //后退
 362   2                case 0x03 : g_fBluetoothDirection =   5000 ;  break;//左转
 363   2                case 0x04 : g_fBluetoothDirection = (-5000);  break;//右转
C51 COMPILER V9.00   UPSTANDINGCAR                                                         11/22/2015 19:59:43 PAGE 7   

 364   2                case 0x05 : g_fBluetoothSpeed =   130 ; break ;
 365   2                case 0x06 : g_fBluetoothSpeed = (-130); break ;
 366   2                case 0x07 : g_fBluetoothDirection =   15000 ;  break;
 367   2                case 0x08 : g_fBluetoothDirection = (-15000);  break;
 368   2                default : g_fBluetoothSpeed = 0; g_fBluetoothDirection = 0;g_iCarSpeedSet=0;break;
 369   2              }
 370   1              
 371   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2280    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =     90      17
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----       2
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
