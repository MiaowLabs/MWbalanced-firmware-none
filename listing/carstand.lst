C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE CARSTAND
OBJECT MODULE PLACED IN .\Output\carstand.obj
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE Appcode\carstand.c LARGE BROWSE INCDIR(.\Appcode;.\BSP;.\Common;.\Driver;.\
                    -Startup;.\Common\inc;.\Driver\inc) DEBUG OBJECTEXTEND PRINT(.\Listing\carstand.lst) OBJECT(.\Output\carstand.obj)

line level    source

   1          /********************************************************************
   2          作者：Songyimiao
   3          建立日期: 20151129
   4          版本：V2.0
   5          喵呜实验室版权所有
   6          /********************************************************************/
   7          #include "includes.h"
   8          
   9          unsigned int xdata g_uiStartCount;
  10          unsigned char xdata g_ucLEDCount;
  11          /******电机控制参数******/
  12          int   g_iCarSpeedSet;
  13          float g_fSpeedControlOut;
  14          float g_fAngleControlOut;
  15          float g_fLeftMotorOut;
  16          float g_fRightMotorOut;
  17          /******角度控制参数******/
  18          int   g_iAccelInputVoltage_X_Axis ;     //加速度X轴数据
  19          int   g_iGyroInputVoltage_Y_Axis  ;     //陀螺仪Y轴数据
  20          int   g_iGyroInputVoltage_Z_Axis  ;     //陀螺仪Y轴数据
  21          long int  g_liAccSum;
  22          long int  g_liGyroSum;
  23          float g_fCarAngle;                              //车模倾角
  24          float g_fGyroAngleSpeed;                        //角速度                        
  25          float g_fGyroscopeAngleIntegral;        //角速度积分值
  26          float g_fGravityAngle;                          //加速度初步计算得到的倾角
  27          int g_iGyroOffset;
  28          /******速度控制参数******/
  29          int   g_iLeftMotorPulse;
  30          int   g_iRightMotorPulse;
  31          int   g_iLeftMotorPulseSigma;
  32          int   g_iRightMotorPulseSigma;
  33          float g_fCarSpeed;
  34          float g_fCarSpeedOld;
  35          float g_fCarPosition;
  36          unsigned char g_ucSpeedControlPeriod ;
  37          unsigned char g_ucSpeedControlCount ;
  38          
  39          /*-----角度环和速度环PID控制参数-----*/
  40          float code g_fcAngle_P = 90.0;  //  85
  41          float code g_fcAngle_D = 3.0;   // 2.8  
  42          float code g_fcSpeed_P = 12.0 ; //  15
  43          float code g_fcSpeed_I = 1.4;   // 1.7
  44          float code g_fcDirection_P = 5.0;                  
  45          /******蓝牙控制参数******/
  46          float xdata g_fBluetoothSpeed;
  47          float xdata g_fBluetoothDirection;
  48          
  49          float xdata g_fDirectionDeviation;
  50          
  51          /***************************************************************
  52          ** 作　  者: Songyimiao
  53          ** 官    网：http://www.miaowlabs.com
  54          ** 淘    宝：http://miaowlabs.taobao.com
C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 2   

  55          ** 日　  期: 2015年11月29日
  56          ** 函数名称: DriversInit
  57          ** 功能描述: 底层驱动初始化            
  58          ** 输　  入:   
  59          ** 输　  出:   
  60          ** 备    注: 
  61          ********************喵呜实验室版权所有**************************
  62          ***************************************************************/
  63          void DriversInit(void)
  64          {
  65   1      
  66   1              GPIOInit();
  67   1              Timer1Init();
  68   1              PWMInit();
  69   1              Uart1Init();
  70   1              Uart2Init();
  71   1              Timer3Timer4Init();
  72   1      
  73   1      }
  74          
  75          /***************************************************************
  76          ** 作　  者: Songyimiao
  77          ** 官    网：http://www.miaowlabs.com
  78          ** 淘    宝：http://miaowlabs.taobao.com
  79          ** 日　  期: 2015年11月29日
  80          ** 函数名称: CarStandInit
  81          ** 功能描述: 直立参数初始化            
  82          ** 输　  入:   
  83          ** 输　  出:   
  84          ** 备    注: 
  85          ********************喵呜实验室版权所有**************************
  86          ***************************************************************/
  87          void CarStandInit()
  88          {
  89   1              g_iAccelInputVoltage_X_Axis = g_iGyroInputVoltage_Y_Axis = 0;
  90   1              g_iLeftMotorPulse = g_iRightMotorPulse = 0;
  91   1              g_iLeftMotorPulseSigma = g_iRightMotorPulseSigma = 0;
  92   1              g_iCarSpeedSet = 0;
  93   1      
  94   1              g_iCarSpeedSet=0;
  95   1              g_fCarSpeed    = 0;
  96   1              g_fCarSpeedOld = 0;
  97   1              g_fCarPosition = 0;
  98   1              g_fCarAngle    = 0;
  99   1              g_fGyroAngleSpeed = 0;
 100   1              g_fGravityAngle   = 0;
 101   1              g_fGyroscopeAngleIntegral = 0;
 102   1      
 103   1              g_fAngleControlOut = g_fSpeedControlOut = 0;
 104   1      
 105   1              g_fLeftMotorOut    = g_fRightMotorOut   = 0;
 106   1              g_fBluetoothSpeed  = g_fBluetoothDirection = 0;
 107   1      
 108   1          g_ucLEDCount = 0;                           
 109   1              g_uiStartCount= 0;
 110   1      }
 111          
 112          /***************************************************************
 113          ** 作　  者: Songyimiao
 114          ** 官    网：http://www.miaowlabs.com
 115          ** 淘    宝：http://miaowlabs.taobao.com
 116          ** 日　  期: 2015年11月29日
C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 3   

 117          ** 函数名称: DataSynthesis
 118          ** 功能描述: 数据合成函数            
 119          ** 输　  入:   
 120          ** 输　  出:   
 121          ** 备    注: 
 122          ********************喵呜实验室版权所有**************************
 123          ***************************************************************/
 124          int DataSynthesis(unsigned char REG_Address)    
 125          {
 126   1              char idata uiHighByte; /*高八位*/
 127   1              char idata ucLowByte; /*低八位*/
 128   1      
 129   1              uiHighByte = Single_ReadI2C(REG_Address)  ;
 130   1              ucLowByte  = Single_ReadI2C(REG_Address+1);
 131   1      
 132   1              return ((uiHighByte << 8) + ucLowByte);   /*返回合成数据*/
 133   1      }
 134          
 135          /***************************************************************
 136          ** 作　  者: Songyimiao
 137          ** 官    网：http://www.miaowlabs.com
 138          ** 淘    宝：http://miaowlabs.taobao.com
 139          ** 日　  期: 2015年11月29日
 140          ** 函数名称: SampleInputVoltage
 141          ** 功能描述: MPU6050采样函数            
 142          ** 输　  入:   
 143          ** 输　  出:   
 144          ** 备    注: 
 145          ********************喵呜实验室版权所有**************************
 146          ***************************************************************/
 147          void SampleInputVoltage(void)
 148          {       
 149   1      
 150   1              g_iGyroInputVoltage_Y_Axis   = DataSynthesis(GYRO_YOUT_H) ; //陀螺仪Y轴
 151   1          g_iAccelInputVoltage_X_Axis  = DataSynthesis(ACCEL_XOUT_H); //加速度X轴     
 152   1              
 153   1              g_iGyroInputVoltage_Z_Axis   = DataSynthesis(GYRO_ZOUT_H) ; //陀螺仪Y轴 
 154   1      
 155   1      }
 156          
 157          /***************************************************************
 158          ** 作　  者: Songyimiao
 159          ** 官    网：http://www.miaowlabs.com
 160          ** 淘    宝：http://miaowlabs.taobao.com
 161          ** 日　  期: 2015年11月29日
 162          ** 函数名称: GyroRevise
 163          ** 功能描述: 陀螺仪校正函数            
 164          ** 输　  入:   
 165          ** 输　  出:   
 166          ** 备    注: 
 167          ********************喵呜实验室版权所有**************************
 168          ***************************************************************/
 169          void GetGyroRevise()
 170          {
 171   1              long int tempsum;
 172   1              int temp;
 173   1              for(temp=0;temp<500;temp++)
 174   1              {
 175   2                      tempsum += DataSynthesis(GYRO_YOUT_H) ;
 176   2              }
 177   1              g_iGyroOffset = (int)(tempsum/500);
 178   1              tempsum=0;
C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 4   

 179   1      }
 180          
 181          /***************************************************************
 182          ** 作　  者: Songyimiao
 183          ** 官    网：http://www.miaowlabs.com
 184          ** 淘    宝：http://miaowlabs.taobao.com
 185          ** 日　  期: 2015年11月29日
 186          ** 函数名称: SetMotorVoltageAndDirection
 187          ** 功能描述: 电机设置函数            
 188          ** 输　  入:   
 189          ** 输　  出:   
 190          ** 备    注: 
 191          ********************喵呜实验室版权所有**************************
 192          ***************************************************************/
 193          void SetMotorVoltageAndDirection(int iLeftVoltage,int iRightVoltage)
 194          {
 195   1              int iLeftMotorValue;
 196   1              int iRighttMotorValue;  
 197   1      
 198   1          if(iLeftVoltage<0)
 199   1          {   
 200   2            AIN1 = 1;                               //右电机前进      角度为负  速度为正
 201   2            AIN2 = 0;
 202   2            iLeftMotorValue = (-iLeftVoltage);
 203   2          }
 204   1          else 
 205   1          {   
 206   2            AIN1 = 0;                               //右电机后退  角度为正  速度为负
 207   2            AIN2 = 1; 
 208   2            iLeftMotorValue = iLeftVoltage;
 209   2          }
 210   1      
 211   1          if(iRightVoltage<0)
 212   1          {   
 213   2            BIN1 = 1;                               //左电机前进  角度为负  速度为正
 214   2            BIN2 = 0;
 215   2            iRighttMotorValue = (-iRightVoltage);
 216   2          }
 217   1          else
 218   1          {   
 219   2            BIN1 = 0;                               //左电机后退  角度为正  速度为负
 220   2            BIN2 = 1; 
 221   2            iRighttMotorValue = iRightVoltage;
 222   2          }
 223   1      
 224   1          //if(iLeftMotorValue   == 0)        CCAP0H=255;
 225   1          //if(iRighttMotorValue == 0)        CCAP1H=255;
 226   1      
 227   1              iLeftMotorValue   = (1000 - iLeftMotorValue)  ;    
 228   1              iRighttMotorValue = (1000 - iRighttMotorValue);
 229   1              
 230   1              PWM3T1 = iLeftMotorValue  ;  
 231   1              PWM4T1 = iRighttMotorValue;  
 232   1      
 233   1              #if IF_CAR_FALL          /*判断车辆是否跌倒，调试用*/
 234   1      
 235   1              if(g_fCarAngle > 30 || g_fCarAngle < (-30))
 236   1              {
 237   2                      AIN1 = 0;                                     //右电机前进      角度为负  速度为正
 238   2              AIN2 = 0; 
 239   2                      BIN1 = 0;                                     //右电机前进      角度为负  速度为正
 240   2              BIN2 = 0;   
C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 5   

 241   2              }
 242   1      
 243   1      #endif
 244   1      
 245   1      }
 246          /***************************************************************
 247          ** 作　  者: Songyimiao
 248          ** 官    网：http://www.miaowlabs.com
 249          ** 淘    宝：http://miaowlabs.taobao.com
 250          ** 日　  期: 2015年11月29日
 251          ** 函数名称: MotorOutput
 252          ** 功能描述: 电机输出函数            
 253          ** 输　  入:   
 254          ** 输　  出:   
 255          ** 备    注: 将直立控制、速度控制、方向控制的输出量进行叠加,并加
 256                                   入死区常量，对输出饱和作出处理。
 257          ********************喵呜实验室版权所有**************************
 258          ***************************************************************/
 259          void MotorOutput(void)
 260          {
 261   1      
 262   1              g_fLeftMotorOut = g_fAngleControlOut - g_fSpeedControlOut + g_fBluetoothDirection + g_fDirectionDeviation
             -;
 263   1              g_fRightMotorOut = g_fAngleControlOut - g_fSpeedControlOut - g_fBluetoothDirection - g_fDirectionDeviatio
             -n;
 264   1                              
 265   1              
 266   1              /*增加死区常数*/
 267   1              if(g_fLeftMotorOut>0)       g_fLeftMotorOut  += MOTOR_OUT_DEAD_VAL;
 268   1              else if(g_fLeftMotorOut<0)  g_fLeftMotorOut  -= MOTOR_OUT_DEAD_VAL;
 269   1              if(g_fRightMotorOut>0)      g_fRightMotorOut += MOTOR_OUT_DEAD_VAL;
 270   1              else if(g_fRightMotorOut<0) g_fRightMotorOut -= MOTOR_OUT_DEAD_VAL;
 271   1      
 272   1              /*输出饱和处理是保证输出量不会超出PWM的满量程范围。*/   
 273   1              if(g_fLeftMotorOut  > MOTOR_OUT_MAX)    g_fLeftMotorOut  = MOTOR_OUT_MAX;
 274   1              if(g_fLeftMotorOut  < MOTOR_OUT_MIN)    g_fLeftMotorOut  = MOTOR_OUT_MIN;
 275   1              if(g_fRightMotorOut > MOTOR_OUT_MAX)    g_fRightMotorOut = MOTOR_OUT_MAX;
 276   1              if(g_fRightMotorOut < MOTOR_OUT_MIN)    g_fRightMotorOut = MOTOR_OUT_MIN;
 277   1      
 278   1          SetMotorVoltageAndDirection(g_fLeftMotorOut,g_fRightMotorOut);
 279   1      }
 280          
 281          
 282          /***************************************************************
 283          ** 作　  者: Songyimiao
 284          ** 官    网：http://www.miaowlabs.com
 285          ** 淘    宝：http://miaowlabs.taobao.com
 286          ** 日　  期: 2015年11月29日
 287          ** 函数名称: GetMotorPulse
 288          ** 功能描述: 捕获电机脉冲函数            
 289          ** 输　  入:   
 290          ** 输　  出:   
 291          ** 备    注: 
 292          ********************喵呜实验室版权所有**************************
 293          ***************************************************************/
 294          void GetMotorPulse(void)
 295          {
 296   1              g_iRightMotorPulse = (T4H<<8) + T4L;
 297   1              g_iLeftMotorPulse  = (T3H<<8) + T3L;
 298   1              T4T3M&= 0x77;
 299   1              T4H=T4L=0;
 300   1              T3H=T3L=0;
C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 6   

 301   1              T4T3M |= 0xCC;
 302   1      
 303   1              if(!MOTOR_LEFT_SPEED_POSITIVE)  g_iLeftMotorPulse  = -g_iLeftMotorPulse ; 
 304   1              if(!MOTOR_RIGHT_SPEED_POSITIVE) g_iRightMotorPulse = -g_iRightMotorPulse;
 305   1              
 306   1              g_iLeftMotorPulseSigma += g_iLeftMotorPulse;
 307   1              g_iRightMotorPulseSigma += g_iRightMotorPulse;    
 308   1      }
 309          
 310          /***************************************************************
 311          ** 作　  者: Songyimiao
 312          ** 官    网：http://www.miaowlabs.com
 313          ** 淘    宝：http://miaowlabs.taobao.com
 314          ** 日　  期: 2015年11月29日
 315          ** 函数名称: SpeedControl
 316          ** 功能描述: 速度环控制函数           
 317          ** 输　  入:   
 318          ** 输　  出:   
 319          ** 备    注: 
 320          ********************喵呜实验室版权所有**************************
 321          ***************************************************************/
 322          void SpeedControl(void)
 323          {  
 324   1              float fP, fDelta;
 325   1              float fI;
 326   1              
 327   1              g_fCarSpeed = (float)(g_iLeftMotorPulseSigma  + g_iRightMotorPulseSigma ) * 0.5f;
 328   1          g_iLeftMotorPulseSigma = g_iRightMotorPulseSigma = 0;         //全局变量 注意及时清零
 329   1      
 330   1              /*低通滤波*/ 
 331   1          g_fCarSpeed = (float)(g_fCarSpeedOld * 0.2f + g_fCarSpeed * 0.8f) ;
 332   1              g_fCarSpeedOld = g_fCarSpeed;
 333   1                                                                                                                                       
 334   1              fDelta = CAR_SPEED_SET;
 335   1              fDelta -= g_fCarSpeed;
 336   1              fP = fDelta * g_fcSpeed_P;
 337   1              fI = fDelta * g_fcSpeed_I;
 338   1              g_fCarPosition += fI;
 339   1      
 340   1              /*积分上限设限*/                          
 341   1              if((int)g_fCarPosition > SPEED_CONTROL_OUT_MAX)    g_fCarPosition = SPEED_CONTROL_OUT_MAX;
 342   1              if((int)g_fCarPosition < SPEED_CONTROL_OUT_MIN)    g_fCarPosition = SPEED_CONTROL_OUT_MIN;
 343   1              g_fCarPosition += g_fBluetoothSpeed;
 344   1      
 345   1              g_fSpeedControlOut = fP + g_fCarPosition;
 346   1              /*
 347   1              //g_fCarSpeed *= CAR_SPEED_CONSTANT;     //单位：转/秒
 348   1              g_fCarPosition += g_fCarSpeed;           //路程  即速度积分
 349   1              g_fCarPosition += g_fBluetoothSpeed;
 350   1              
 351   1              //积分上限设限                    
 352   1              if((int)g_fCarPosition > SPEED_CONTROL_OUT_MAX)    g_fCarPosition = SPEED_CONTROL_OUT_MAX;
 353   1              if((int)g_fCarPosition < SPEED_CONTROL_OUT_MIN)    g_fCarPosition = SPEED_CONTROL_OUT_MIN;
 354   1                                                              
 355   1              g_fSpeedControlOut = (CAR_SPEED_SET - g_fCarSpeed) * g_fcSpeed_P + \
 356   1              (CAR_POSITION_SET - g_fCarPosition) * g_fcSpeed_I;  
 357   1              */
 358   1      }
 359          
 360          /***************************************************************
 361          ** 作　  者: Songyimiao
 362          ** 官    网：http://www.miaowlabs.com
C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 7   

 363          ** 淘    宝：http://miaowlabs.taobao.com
 364          ** 日　  期: 2015年11月29日
 365          ** 函数名称: AngleControl
 366          ** 功能描述: 角度环控制函数           
 367          ** 输　  入:   
 368          ** 输　  出:   
 369          ** 备    注: 
 370          ********************喵呜实验室版权所有**************************
 371          ***************************************************************/
 372          void AngleControl(void)  
 373          {  
 374   1              //去除零点偏移,计算得到加速度传感器的角度（弧度）
 375   1              g_fGravityAngle = (float)(g_iAccelInputVoltage_X_Axis - GRAVITY_OFFSET) / 16384.0f;
 376   1              // 57.2957795=180/3.1415926535898 弧度转换为度
 377   1              g_fGravityAngle = g_fGravityAngle * 57.2957795f ;
 378   1      
 379   1              g_fGyroAngleSpeed = (g_iGyroInputVoltage_Y_Axis - GYRO_OFFSET) / GYROSCOPE_ANGLE_RATIO *(-1);
 380   1              //互补滤波
 381   1              g_fCarAngle = 0.99f*(g_fCarAngle + g_fGyroAngleSpeed * 0.008f) + 0.01f * g_fGravityAngle;
 382   1              //角度环PID控制
 383   1              g_fAngleControlOut = (CAR_ANGLE_SET - g_fCarAngle)* g_fcAngle_P + \
 384   1              (CAR_ANGULARSPEED_SET - g_fGyroAngleSpeed )* g_fcAngle_D ;         
 385   1               
 386   1      }
 387          
 388          /***************************************************************
 389          ** 函数名称: BluetoothControl
 390          ** 功能描述: 蓝牙控制函数
 391                       手机发送内容
 392                                   前进：0x01    后退：0x02
 393                       左：  0x03    右：  0x04
 394                       停止：0x10
 395                       功能键（可自编下位机程序扩展）：
 396                       左自旋：0x07
 397                                   右自旋：0x08
 398                                   更快地前进：0x09  更慢地前进：0x0A
 399                                   更慢地后退：0x0B  更慢地后退：0x0C   巡线启动：0x0D
 400          ** 输　入:   
 401          ** 输　出:   
 402          ** 全局变量: 
 403          ** 作　者:   喵呜实验室
 404          ** 淘  宝：  Http://miaowlabs.taobao.com
 405          ** 日　期:   2014年08月01日
 406          ***************************************************************/
 407          void BluetoothControl(void)      
 408          {
 409   1              unsigned char xdata ucBluetoothValue;
 410   1      
 411   1              //LED0=~LED0;
 412   1      
 413   1              ucBluetoothValue = UART2ReceiveByte();          
 414   1                      
 415   1              switch (ucBluetoothValue)
 416   1              {
 417   2                //case 0x02 : g_iCarSpeedSet =   50 ;  break;    //后退
 418   2                //case 0x01 : g_iCarSpeedSet = (-50);  break;    //前进
 419   2      
 420   2                case 0x02 : g_fBluetoothSpeed =   40 ;  break;           //后退
 421   2                case 0x01 : g_fBluetoothSpeed = (-40);  break;           //前进
 422   2                case 0x03 : g_fBluetoothDirection =   200 ;  break;//左转
 423   2                case 0x04 : g_fBluetoothDirection = (-200);  break;//右转
 424   2                case 0x05 : g_iCarSpeedSet =   20 ; break ;
C51 COMPILER V9.00   CARSTAND                                                              03/29/2016 23:03:25 PAGE 8   

 425   2                case 0x06 : g_iCarSpeedSet = (-20); break ;
 426   2                case 0x07 : g_fBluetoothDirection =   400 ;  break;
 427   2                case 0x08 : g_fBluetoothDirection = (-400);  break;
 428   2                case 0x0D : g_iCarSpeedSet = 8;  break;          //前进
 429   2                default : g_fBluetoothSpeed = 0; g_fBluetoothDirection = 0;g_iCarSpeedSet=0;break;
 430   2              }
 431   1      }
 432          
 433          void EliminateDirectionDeviation(void)
 434          {
 435   1              int Delta=0;
 436   1      
 437   1              //Delta = g_iGyroInputVoltage_Z_Axis - 0;
 438   1              Delta = g_iLeftMotorPulseSigma - g_iRightMotorPulseSigma;
 439   1      
 440   1              g_fDirectionDeviation = Delta * g_fcDirection_P * (-1);
 441   1      
 442   1      
 443   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2327    ----
   CONSTANT SIZE    =     20    ----
   XDATA SIZE       =     87      23
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----       2
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
